<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Stock Analytics</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<!-- Navbar -->
<nav class="navbar mb-4" style="background-color: #161b22; border-bottom: 1px solid #30363d;">
  <div class="container justify-content-center">
    <span class="navbar-title" style="color: #58a6ff; font-weight: 700; font-size: 1.8rem;"> Analytics </span>
  </div>
</nav>

<div class="container py-4">

  <!-- Search -->
  <form method="get" action="/analytics" class="d-flex justify-content-center mb-4 gap-2">
    <input type="text" name="company" class="form-control" placeholder="Search company..." 
           value="{{ companies[0] if companies|length == 1 else '' }}">
    <button type="submit" class="btn btn-run">Search</button>
  </form>

 <!-- Charts Column -->
<div class="row g-4" id="charts-container"></div>

<script>
const stockData = {{ stock_data | tojson }};
const companies = {{ companies | tojson }};
const container = document.getElementById("charts-container");

companies.forEach(company => {
    if (!stockData[company] || !stockData[company].ohlc || stockData[company].ohlc.length === 0) {
        console.warn("No OHLC data for", company);
        return;
    }

    const candleData = stockData[company].ohlc;

    const chartDiv = document.createElement("div");
    chartDiv.classList.add("col-12");
    chartDiv.innerHTML = `
      <div class="chart-card">
        <h4>${company.toUpperCase()}</h4>
        <div id="candle-${company}" class="chart-container"></div>
      </div>`;
    container.appendChild(chartDiv);

    const traceLine = {
      x: candleData.map(d => d.x),   // e.g. "09:15"
      y: candleData.map(d => d.c),
      type: 'scatter',
      mode: 'lines',
      line: { shape: 'spline', color: '#26a69a', width: 2 },
      hovertemplate: '%{x} → %{y:.2f} ₹<extra></extra>'
    };

    const layout = {
      plot_bgcolor: "#161b22",
      paper_bgcolor: "#0d1117",
      font: { color: "#c9d1d9" },
      margin: { t: 20, b: 40, l: 50, r: 20 },
      xaxis: {
        type: 'category',   // ✅ use category since x = "09:15"
        showgrid: true,
        gridcolor: '#1e222d',
        tickvals: ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','15:30'],
        ticktext: ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','15:30']
      },
      yaxis: { title: "Price (₹)", showgrid: true, gridcolor: '#1e222d' },
      hovermode: 'x unified'
    };

    Plotly.newPlot(`candle-${company}`, [traceLine], layout, {responsive:true, displayModeBar:false});
});
</script>

</body>
</html>
