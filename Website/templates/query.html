<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SQL Query Scheduler</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
</head>
<body>
<div class="container mt-5">

  <div class="card custom-card shadow-lg mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <h2 class="card-title mb-0 text-accent">ðŸ’» SQL Query Scheduler</h2>
      <button type="button" id="check-schedule-btn" class="btn btn-run btn-icon">Check Schedule</button>
    </div>
  </div>

  <div class="scheduled-query-box">
    <form method="post" action="{{ url_for('query_page') }}">

      <div class="form-group mb-3">
        <label for="query" class="form-label fw-bold">Enter SQL Query:</label>
        <textarea class="form-control custom-textarea" id="query" name="query" rows="6" placeholder="SELECT * FROM my_table;">{{ request.form.query or '' }}</textarea>
      </div>

      <div class="scheduler-buttons">
        <button type="button" class="btn btn-scheduler-option active" data-value="now">â–¶ Run Now</button>
        <button type="button" class="btn btn-scheduler-option" data-value="once">â–¶ Run Once</button>
        <button type="button" class="btn btn-scheduler-option" data-value="daily">â–¶ Run Daily</button>
      </div>

      <div class="confirm-btn-container">
        <button type="submit" name="action" value="confirm" class="btn btn-run btn-icon">Confirm Query</button>
      </div>

      <input type="hidden" name="schedule_type" id="schedule_type" value="now">

      <div class="mt-3" id="schedule_datetime_container" style="display:none;">
        <input type="datetime-local" class="form-control custom-input" id="run_schedule_time" name="run_schedule_time">
      </div>

      {% if error %}
        <div class="alert alert-danger mt-3">{{ error }}</div>
      {% endif %}
      {% if message %}
        <div class="alert alert-success mt-3">{{ message }}</div>
      {% endif %}

    </form>
  </div>

  {% if results %}
    <div class="card custom-card mt-4 shadow">
      <div class="card-body">
        <h4 class="card-title text-accent">ðŸ“Š Query Results</h4>
        <div class="table-responsive table-container mt-3">
          <table class="table table-dark table-hover custom-dark-table">
            <thead>
              <tr>
                {% for col in columns %}
                  <th>{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in results %}
                <tr>
                  {% for col in row %}
                    <td>{{ col }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

</div>

<div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ“‹ Scheduled Queries</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-dark table-hover table-sm mb-0">
            <thead>
              <tr>
                <th>Sender</th>
                <th>Receiver</th>
                <th>Query</th>
                <th>Status</th>
                <th>Scheduled Time</th>
              </tr>
            </thead>
            <tbody id="scheduled-queries-body-modal"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
const buttons = document.querySelectorAll('.btn-scheduler-option');
const scheduleTypeInput = document.getElementById('schedule_type');
const scheduleContainer = document.getElementById('schedule_datetime_container');
const form = document.querySelector('form');
const confirmBtn = form.querySelector('button[name="action"]');
const checkScheduleBtn = document.getElementById('check-schedule-btn');
const scheduleBodyModal = document.getElementById('scheduled-queries-body-modal');

buttons.forEach(btn => {
  btn.addEventListener('click', () => {
    buttons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    scheduleTypeInput.value = btn.dataset.value;

    if(btn.dataset.value === 'once' || btn.dataset.value === 'daily'){
      scheduleContainer.style.display = 'block';
      scheduleContainer.querySelector('input').disabled = false;
    } else {
      scheduleContainer.style.display = 'none';
      scheduleContainer.querySelector('input').disabled = true;
    }
  });
});

form.addEventListener('submit', () => {
  confirmBtn.value = (scheduleTypeInput.value === 'now') ? 'confirm' : 'schedule';
});

checkScheduleBtn.addEventListener('click', async () => {
  const response = await fetch('/get-scheduled-queries');
  const data = await response.json();
  scheduleBodyModal.innerHTML = '';
  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.sender}</td>
      <td>${item.receiver}</td>
      <td style="max-width:300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.query}</td>
      <td>${item.status}</td>
      <td>${item.scheduled_time || '-'}</td>
    `;
    scheduleBodyModal.appendChild(row);
  });
  const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
  scheduleModal.show();
});
</script>
</body>
</html>
