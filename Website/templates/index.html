<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

<canvas id="stocks-bg"></canvas>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
  <a class="navbar-brand fw-bold text-primary" href="#">MyStocks</a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a class="nav-link" href="{{ url_for('key_check') }}">Query</a></li>
      <li class="nav-item"><a class="nav-link" href="https://app.powerbi.com/links/crFivbhXYo?ctid=6a98ca7f-fa62-430e-8b86-32afb61b30fa&pbi_source=linkShare" target="_blank">Dashboard</a></li>
    </ul>
  </div>
</nav>

<div class="main-content container-fluid mt-4">
  <div class="row align-items-start">

    <div class="col-md-3">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header border-0">
          <h5 class="mb-0 text-light">My Programs</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn-program" onclick="runProgram('prediction','Actual vs Prediction')"> Actual vs Prediction</button>
            <button class="btn-program" onclick="runProgram('final','Final Analysis')">Final Analysis</button>
            <button class="btn-program" onclick="runProgram('news','News Extractor')"> News Extractor</button>
            <button class="btn-program" onclick="runProgram('sentiment','Sentiment Analyzer')"> Sentiment Analyzer</button>
            <button class="btn-program" onclick="runProgram('stockdata','Stock Data Daily')"> Stock Data Daily</button>
          </div>

          <div id="progressContainer" class="mt-3" style="display:none;">
            <div class="progress">
              <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
            </div>
            <small id="progressStatus" class="text-muted"></small>
          </div>
        </div>
      </div>

      <div class="query-schedule-container text-center mt-3">
        <button class="query-schedule-box"> Query Schedule</button>
        <div id="scheduleHoverList">
          <ul class="mb-0"></ul>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="card bg-panel mb-3">
        <div class="card-body">
          <h5 class="card-title text-accent">Search Company</h5>
          <form id="searchForm" class="d-flex">
            <input id="searchInput" class="form-control me-2" type="text" placeholder="Enter company name or symbol" list="companyList" aria-label="Search">
            <datalist id="companyList">
              {% for company in company_list %}
                <option value="{{ company | capitalize }}"></option>
              {% endfor %}
            </datalist>
            <button class="btn btn-primary" type="submit">Search</button>
          </form>
        </div>
      </div>

      <div id="mini-charts-grid" class="mini-charts-grid mt-4"></div>
    </div>
  </div>
</div>

<footer class="text-center text-muted py-3 bg-dark mt-4">
  <small>© 2025 MyStocks Dashboard. All rights reserved.</small>
</footer>

<script>
const miniChartsGrid = document.getElementById('mini-charts-grid');
const companiesToShow = ['RELIANCE.NS','TCS.NS','INFY.NS','BAJFINANCE.NS','ICICIBANK.NS','KOTAKBANK.NS','HCLTECH.NS','LT.NS','ITC.NS','SBIN.NS','BHARTIARTL.NS','ASIANPAINT.NS'];

fetch('/prediction-vs-actual')
  .then(res => res.json())
  .then(data => {
    const filteredData = data.filter(item => companiesToShow.includes(item.ticker.trim().toUpperCase()));
    if (!filteredData.length) { miniChartsGrid.innerHTML = "<p class='text-muted'>No mini chart data available.</p>"; return; }

    miniChartsGrid.style.display = 'grid';
    miniChartsGrid.style.gridTemplateColumns = 'repeat(4, 1fr)';
    miniChartsGrid.style.gridAutoRows = '180px';
    miniChartsGrid.style.gap = '20px';

    filteredData.forEach(item => {
      const wrapper = document.createElement('div');
      wrapper.classList.add('mini-chart-wrapper');
      wrapper.style.textAlign = 'center';

      const canvas = document.createElement('canvas');
      canvas.id = `chart-${item.ticker}`;
      canvas.style.height = '100px';
      wrapper.appendChild(canvas);

      const label = document.createElement('div');
      label.innerText = item.ticker;
      label.style.marginTop = '5px';
      label.style.fontSize = '0.9rem';
      label.style.color = '#fff';
      wrapper.appendChild(label);

      miniChartsGrid.appendChild(wrapper);

      new Chart(canvas, {
        type: 'bar',
        data: {
          labels: ['Predicted','Actual'],
          datasets: [{ data: [item.predicted,item.actual], backgroundColor:['#4caf50','#f44336'] }]
        },
        options: { responsive:false, plugins:{legend:{display:false}}, scales:{x:{display:true,title:{display:true,text:'Type'}},y:{display:true,title:{display:true,text:'Price'}}} }
      });
    });
  })
  .catch(err => { console.error("Error fetching prediction vs actual:", err); miniChartsGrid.innerHTML = "<p class='text-muted'>Failed to load mini charts.</p>"; });

document.getElementById('searchForm').addEventListener('submit', function(e){
  e.preventDefault();
  let company = document.getElementById('searchInput').value.trim().toLowerCase();
  if(company) window.location.href = `/company/${company}`;
});

const canvas = document.getElementById("stocks-bg");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const symbols = ["₹","$","%","↑","↓"];
const particles = Array.from({length:40},()=>({text:symbols[Math.floor(Math.random()*symbols.length)],x:Math.random()*canvas.width,y:Math.random()*canvas.height,speed:Math.random()*0.5+0.3,size:Math.random()*20+14,opacity:Math.random()*0.7+0.3}));

function drawGraph(){
  ctx.strokeStyle = "rgba(0,200,100,0.2)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  let y = canvas.height/2 + (Math.random()*40-20);
  ctx.moveTo(0,y);
  for(let x=0;x<=canvas.width;x+=20){y+=Math.random()*40-20;ctx.lineTo(x,y);}
  ctx.stroke();
}

let frame=0;
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(frame%100===0) drawGraph();
  ctx.font="bold 18px Arial";
  particles.forEach(p=>{
    ctx.globalAlpha=p.opacity;
    ctx.fillStyle="white";
    ctx.fillText(p.text,p.x,p.y);
    p.y+=p.speed;
    if(p.y>canvas.height){p.y=0;p.x=Math.random()*canvas.width;}
  });
  frame++;
  requestAnimationFrame(draw);
}
draw();
window.addEventListener("resize",()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});

function runProgram(program,label){
  const progressContainer=document.getElementById("progressContainer");
  const bar=document.getElementById("progressBar");
  const status=document.getElementById("progressStatus");
  progressContainer.style.display="block";
  bar.classList.remove("bg-danger");
  let width=0;
  const interval=setInterval(()=>{if(width<95){width++;bar.style.width=width+"%";bar.textContent=width+"%";}},300);

  fetch(`/run/${program}`).then(r=>r.text()).then(d=>{
    clearInterval(interval); bar.style.width="100%"; bar.textContent="100%";
    setTimeout(()=>{progressContainer.style.display="none"; showToast(`✅ ${label} ran successfully`,"success",10000);},500);
  }).catch(err=>{
    clearInterval(interval); bar.style.width="100%"; bar.classList.add("bg-danger"); bar.textContent="Error";
    setTimeout(()=>{progressContainer.style.display="none"; showToast(`❌ ${label} failed`,"error",10000);},500);
  });
}

function showToast(message,type="success",duration=10000){
  let container=document.getElementById("toastContainer");
  let toast=document.createElement("div");
  toast.className=`toast ${type}`;
  toast.innerText=message;
  container.appendChild(toast);
  setTimeout(()=>toast.classList.add("show"),100);
  setTimeout(()=>{toast.classList.remove("show"); setTimeout(()=>toast.remove(),400);},duration);
}

fetch('/get-scheduled-queries')
  .then(res=>res.json())
  .then(data=>{
    const list=document.getElementById("scheduleHoverList").querySelector("ul");
    list.innerHTML="";
    if(!data.length){ list.innerHTML="<li class='list-group-item text-muted bg-dark'>No schedules yet</li>"; return; }
    data.forEach(item=>{
      let statusText="Scheduled", statusClass="text-warning";
      if(item.status==="Ran"){statusText="Ran"; statusClass="text-success";}
      else if(item.status==="Failed"){statusText="Failed"; statusClass="text-danger";}
      const li=document.createElement("li");
      li.className="list-group-item bg-dark d-flex justify-content-between align-items-center";
      li.innerHTML=`<span>${item.query} → ${item.scheduled_time || 'Now'}</span><span class="${statusClass}"><strong>${statusText}</strong></span>`;
      list.appendChild(li);
    });
  })
  .catch(err=>console.error("Error fetching schedule list:",err));
</script>

<div id="toastContainer"></div>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
</body>
</html>